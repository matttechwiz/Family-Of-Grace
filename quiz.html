<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Family of Grace Quiz</title>
  <style>
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .overlay .card {
      max-width: 400px;
      width: 100%;
    }
    .logo img{
      height: 40px;
      width: 40px;
    }

:root{
  --brand:#5b8def;
  --brand-dark:#3b6fd6;
  --text:#0f172a;
  --muted:#64748b;
  --bg:#f8fafc;
  --card:#ffffff;
  --accent:#22c55e;
  --danger:#ef4444;
  --warning:#f59e0b;
  --radius:18px;
  --shadow: 0 10px 30px rgba(2,6,23,.08);
}

*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,Helvetica,sans-serif;
  color:var(--text);
  background:var(--bg);
  line-height:1.6;
}

.container{
  width:min(1100px, 92%);
  margin-inline:auto;
}

.navbar{
  position:sticky; top:0; z-index:50;
  background:rgba(248,250,252,.8);
  backdrop-filter: blur(8px);
  border-bottom:1px solid #e2e8f0;
}
.navbar .inner{
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 0;
}
.brand{
  display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;
}
.brand .logo{
  width:38px; height:38px; display:grid; place-items:center; border-radius:12px; 
  background:linear-gradient(135deg,var(--brand),#93c5fd);
  color:white; font-weight:900; box-shadow:var(--shadow);
}
.nav-links{display:flex; gap:18px; align-items:center;}
.nav-links a{
  text-decoration:none; color:var(--text); font-weight:600; padding:10px 14px; border-radius:12px;
}
.nav-links a.cta{
  background:var(--brand); color:white; box-shadow:var(--shadow);
}
.nav-links a:hover{background:#e2e8f0}

.hero{
  display:grid; grid-template-columns:1.2fr .8fr; gap:28px; align-items:center;
  padding:56px 0 24px;
}
.hero h1{
  font-size:clamp(32px, 3.8vw, 54px);
  line-height:1.1; margin:0 0 12px;
}
.hero p{color:var(--muted); font-size:18px; margin:0 0 22px}
.hero .card{
  background:var(--card); border-radius:var(--radius); padding:22px; box-shadow:var(--shadow);
}

.grid-3{
  display:grid; grid-template-columns:repeat(3,1fr); gap:18px;
}
.card{
  background:var(--card); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow);
}

.section{padding:40px 0}
.section h2{font-size:28px; margin:0 0 14px}
.muted{color:var(--muted)}

.list{
  display:grid; gap:10px;
}
.badge{
  display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px;
  background:#e2e8f0; color:#0f172a; font-weight:700; letter-spacing:.3px;
}

.footer{
  margin-top:40px; padding:24px 0; border-top:1px solid #e2e8f0; color:var(--muted);
}

.hero-illustration{
  border-radius:var(--radius);
  height:100%;
  min-height:260px;
  background: radial-gradient(1200px 300px at -10% -40%, #c7d2fe 0, transparent 60%),
              radial-gradient(600px 240px at 80% 0%, #bfdbfe 0, transparent 60%),
              linear-gradient(135deg, #f0f9ff, #ffffff 60%);
  box-shadow:var(--shadow);
  border:1px solid #e2e8f0;
  display:grid; place-items:center;
}
.hero-illustration .ring{
  width:160px; height:160px; border-radius:999px;
  border:14px solid rgba(59,112,214,.15);
  display:grid; place-items:center;
  animation: spin 18s linear infinite;
}
.hero-illustration .dot{
  width:18px; height:18px; border-radius:999px; background:var(--brand);
  box-shadow:0 0 0 10px rgba(91,141,239,.12), 0 0 0 22px rgba(91,141,239,.08);
}

@keyframes spin{to{transform:rotate(360deg)}}

.btn{
  border:0; padding:12px 16px; border-radius:12px; font-weight:700;
  background:var(--brand); color:white; cursor:pointer; box-shadow:var(--shadow);
}
.btn.secondary{background:#e2e8f0; color:#0f172a}
.btn.danger{background:var(--danger)}
.btn.warning{background:var(--warning)}
.btn:disabled{opacity:.6; cursor:not-allowed}

.table{
  width:100%; border-collapse:separate; border-spacing:0 10px;
}
.table thead th{font-size:12px; text-transform:uppercase; letter-spacing:.8px; color:var(--muted)}
.table tbody tr{
  background:var(--card); box-shadow:var(--shadow);
}
.table td, .table th{padding:12px 14px}
.table tbody tr td:first-child, .table thead th:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
.table tbody tr td:last-child, .table thead th:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}

.input, select, .date, textarea.sa {
  width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e2e8f0; background:white;
  font-family:inherit;
}

.kpis{
  display:grid; grid-template-columns:repeat(4,1fr); gap:12px;
}
.kpi{background:var(--card); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}
.kpi .value{font-size:24px; font-weight:800}

.timer{
  height:10px; background:#e2e8f0; border-radius:999px; overflow:hidden;
}
.timer .bar{height:100%; width:100%; background:var(--accent); transition:width .3s linear}

.notice{
  border-left:4px solid var(--brand);
  background:#eff6ff; color:#0c4a6e;
  padding:12px 14px; border-radius:12px; margin:14px 0;
}

.card.small { padding:14px; }

.reflection {
  margin-top: 8px;
  display: grid;
  gap: 12px;
}

/* Keep short-answer section visually separated from MCQs */
.reflection .section-title {
  font-weight:800;
  font-size:16px;
  color:var(--brand-dark);
  margin-bottom:4px;
}

/* small responsive */
@media (max-width: 920px){
  .hero{grid-template-columns:1fr; padding-top:32px; text-align:center;}
  .grid-3{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr 1fr}
}

@media (max-width: 520px){
  .nav-links{display:none}
}
  </style>
</head>
<body>
  <header class="navbar">
    <div class="container inner">
      <a class="brand" href="index.html">
        <div class="logo"><img src="./photo_2025-09-03_01-35-31-removebg-preview.png" alt=""></div>
        <div>Family of Grace </div>
      </a>
      <nav class="nav-links">
        <a href="index.html">Home</a>
      </nav>
    </div>
  </header>

  <!-- Login Overlay -->
  <div class="overlay" id="loginOverlay">
    <div class="card" style="padding:20px; text-align:center">
      <h2>Enter Details</h2>
      <p class="muted">Provide your name and access code to start</p>
      <input type="text" id="playerName" class="input" placeholder="Your Name" style="width:100%;margin-bottom:10px">
      <input type="text" id="playerCode" class="input" placeholder="Access Code" style="width:100%;margin-bottom:10px">
      <button id="startBtn" class="btn" style="width:100%">Start Quiz</button>
    </div>
  </div>

  <main class="container" style="display:none" id="quizMain">
    <section class="section">
      <div class="badge"> FAMILY OF GRACE MONTHLY BIBLE QUIZ • ESTHER</div>
      <h1>Answer 21 questions in 900 seconds</h1>
      <p class="muted" style="color: red;">Questions are randomly drawn from the Book of ESTHER. <br> NOTE: Submit a screenshot of your score and your reflection questions answers!</p>

      <div class="card" style="display:grid; gap:14px">
        <div class="timer"><div id="bar" class="bar"></div></div>
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between">
          <div><strong>Time Left: <span id="timeLeft">900</span>s</strong></div>
          <div class="muted">Score: <span id="scoreNow">0</span>/21</div>
        </div>

        <!-- Multiple-choice quiz form -->
        <form id="quizForm" class="list" autocomplete="off"></form>

        <!-- Reflection / short-answer section (separate and clearly below MCQs) -->
        <div class="card small" id="reflectionCard" aria-labelledby="reflectionTitle">
          <div id="reflectionTitle" class="section-title" style="color: red;">Reflection & Answers (please type in the boxes)</div>
          <div class="reflection" id="reflectionList">
            <!-- Short-answer fields are injected here -->
          </div>
        </div>

        <div style="display:flex; gap:10px">
          <button id="submitBtn" class="btn">Submit Answers</button>
          <button id="retryBtn" class="btn secondary" type="button"></button>
        </div>
      </div>
      <div id="result" class="notice" style="display:none"></div>
    </section>

    <section class="section">
      <h2>Participants Results</h2>
      <div class="card" style="overflow:auto">
        <table class="table" id="resultsTable">
          <thead>
            <tr>
              <th>Pos</th>
              <th>Name</th>
              <th>Code</th>
              <th>Score</th>
              <th>Time Used (s)</th>
              <th>Date</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
      <button id="exportResultsBtn" class="btn warning" style="margin-top:10px">Export Results CSV</button>
    </section>
  </main>

  <footer class="footer">
    <div class="container">© <span id="year"></span> Family of Grace</div>
  </footer>

<script>
document.getElementById('year').textContent = new Date().getFullYear();

// === Codes ===
const VALID_CODES = [
  "FG161","FG122","FG193","FG345","FG949",
  "FG232","FG832","FG803","FG912","FG110",
  "FG111","FG112","FG113","FG114","FG115",
  "FG116","FG117","FG118","FG119","FG120"
];

// === Quiz Questions (multiple-choice) ===
const BANK = [
  { q: "For how many days did King Ahasuerus show the riches of his glorious kingdom?", options: ["7 days", "100 days", "180 days", "365 days"], a: 2 },
  { q: "On what colors were the cords of fine linen hung in the palace garden?", options: ["Scarlet, yellow, and black", "White, green, and gold", "White, blue, and purple", "Blue, silver, and crimson"], a: 2 },
  { q: "The beds (or couches) were of what metals?", options: ["Bronze and iron", "Gold and silver", "Silver and bronze", "Gold and bronze"], a: 1 },
  { q: "On what day of the feast did the king command Queen Vashti to be brought before him?", options: ["The first day", "The third day", "The seventh day", "The final day of the 180-day feast"], a: 2 },
  { q: "Which of these was NOT one of the seven princes of Persia and Media?", options: ["Haman", "Carshena", "Memucan", "Marsena"], a: 0 },
  { q: "According to Memucan, what would all the women of the empire do once they heard of the queen's deed?", options: ["Honor their husbands more", "Refuse to come when called", "Despise their husbands", "Demand their own feasts"], a: 2 },
  { q: "What was the final part of the king's decree regarding every man?", options: ["That he must serve in the king's army", "That he should be the ruler in his own house", "That he must pay a tax to the crown", "That he should speak only the language of his own people"], a: 1 },
  { q: "Who was Mordecai's father?", options: ["Kish", "Jair", "Shimei", "Abihail"], a: 1 },
  { q: "What was Esther's Hebrew name?", options: ["Miriam", "Deborah", "Hadassah", "Rachel"], a: 2 },
  { q: "For how long did the purification process for the women last?", options: ["40 days", "6 months", "Twelve months", "3 months"], a: 2 },
  { q: "With what was a woman purified before she went in to the king?", options: ["Water and hyssop", "Oil of myrrh and sweet odors", "Wine and spices", "Perfumed soaps and lotions"], a: 1 },
  { q: "In what month did Esther go in to the king?", options: ["The month of Nisan", "The month of Sivan", "The month of Tebeth", "The month of Adar"], a: 2 },
  { q: "Who were the two chamberlains that Mordecai discovered plotting against the king?", options: ["Hegai and Shaashgaz", "Bigthan and Teresh", "Carshena and Shethar", "Meres and Marsena"], a: 1 },
  { q: "What had Mordecai charged Esther not to do?", options: ["Not to eat the king's food", "Not to bow to Haman", "Not to reveal her people or kindred", "Not to speak Hebrew in the palace"], a: 2 },
  { q: "Who was Haman's father?", options: ["Hammedatha", "Agag", "Memucan", "Hathach"], a: 0 },
  { q: "Why did Mordecai refuse to bow to Haman?", options: ["Because Haman had insulted him", "Because he was a Jew", "Because the king had forbidden it", "Because he was of higher royal rank"], a: 1 },
  { q: "In what month did Haman cast the lot (Pur) to determine the date for the Jews' destruction?", options: ["The first month, Nisan", "The third month, Sivan", "The twelfth month, Adar", "The seventh month, Tishri"], a: 0 },
  { q: "How much silver did Haman offer to pay into the king's treasury for the destruction of the Jews?", options: ["1,000 talents of silver", "10,000 talents of silver", "100 pieces of silver", "He offered a percentage of the plunder"], a: 1 },
  { q: "What did the king give Haman to seal the decree?", options: ["His royal scepter", "A sealed letter", "The king's signet ring", "A crown of gold"], a: 2 },
  { q: "On what day of the month of Adar was the decree to be carried out?", options: ["The first day", "The thirteenth day", "The fourteenth day", "The tenth day"], a: 1 },
  { q: "⁠what prompted the disobedience of the queen", options: ["Drunk", "angry", "pride", "None of the above"], a: 2 }
];

const TOTAL = 21;
let picked = [];
let timer = 900;
let intervalId = null;
let currentPlayer = null;
let quizStartTime = null;

const form = document.getElementById('quizForm');
const submitBtn = document.getElementById('submitBtn');
const retryBtn = document.getElementById('retryBtn');
const timeLeft = document.getElementById('timeLeft');
const bar = document.getElementById('bar');
const result = document.getElementById('result');
const scoreNow = document.getElementById('scoreNow');
const resultsBody = document.getElementById('resultsBody');

// Reflection / short-answer questions (these are separate from the multiple-choice bank)
const REFLECTION_QUESTIONS = [
  "1. What was the essence of the king chamberlain decision?",
  "2. Do you think the decision (regarding Vashti) was favourable or a betrayal?",
  "3. The text states that after signing the genocidal decree, the king and Haman 'sat down to drink.' What does this specific action (or inaction) reveal about their characters and their understanding of royal power versus moral responsibility?",
  "4. Mordecai instructs Esther to conceal her Jewish identity, which ultimately allows her to become queen. Analyze the ethical tension between this strategic deception and the potential risk of assimilation or loss of identity. Was this a necessary act of wisdom for a greater good, or a compromise of principle?",
  "5. Queen Vashti's refusal to appear is a pivotal act of defiance. Was her primary motivation more likely a stand for personal dignity against objectification, a calculated political challenge, or an adherence to a different cultural or personal code? Justify your reasoning.",
  "6. Memucan frames his advice about deposing Vashti as a necessity to prevent social chaos and the contempt of husbands across the empire. Was his argument a genuine concern for social order, or a pretext for reinforcing patriarchal authority and controlling female agency? Explain.",
  "7. Haman's rage toward Mordecai is described as personal, but his response is to plot genocide against an entire people. What does this escalation from a personal insult to a collective punishment reveal about the nature of prejudice and political power in the story?"
];

// Local storage key
const STORAGE_KEY = "fg_quiz_results";

// === Shuffle helper ===
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function pickQuestions(){
  const ids = [...Array(BANK.length).keys()];
  shuffle(ids);
  return ids.slice(0,TOTAL).map(i=>BANK[i]);
}

function renderQuiz(){
  picked = pickQuestions();
  form.innerHTML = "";
  // Render multiple-choice questions
  picked.forEach((item,idx)=>{
    const name="q"+idx;
    const block=document.createElement("div");
    block.className="card";
    block.innerHTML=`<strong>Q${idx+1}.</strong> ${item.q}`;
    const list=document.createElement("div");
    list.className="list";
    item.options.forEach((opt,oi)=>{
      const id=`${name}_${oi}`;
      const row=document.createElement("label");
      row.style.display="flex";
      row.style.alignItems="center";
      row.style.gap="10px";
      row.innerHTML=`<input type="radio" name="${name}" value="${oi}" id="${id}"><span>${opt}</span>`;
      list.appendChild(row);
    });
    block.appendChild(list);
    form.appendChild(block);
  });

  // Render the reflection / short-answer fields (separate and below the MCQs)
  const reflectionList = document.getElementById('reflectionList');
  reflectionList.innerHTML = "";
  REFLECTION_QUESTIONS.forEach((q, i) => {
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <label style="font-weight:700; display:block; margin-bottom:6px;">${q}</label>
      <textarea name="sa${i+1}" id="sa${i+1}" class="sa" rows="3" placeholder="Type your answer here..."></textarea>
    `;
    reflectionList.appendChild(wrapper);
  });

  scoreNow.textContent="0";
  result.style.display="none";
  submitBtn.disabled=false;
}

function startTimer(){
  clearInterval(intervalId);
  timer=900;
  timeLeft.textContent=timer;
  bar.style.width="100%";
  quizStartTime = Date.now();
  intervalId=setInterval(()=>{
    timer--;
    timeLeft.textContent=timer;
    // compute percentage correctly
    const pct = Math.max(0, (timer / 900) * 100);
    bar.style.width = pct + "%";
    if(timer<=0){
      clearInterval(intervalId);
      grade(true);
    }
  },1000);
}

function grade(auto=false){
  clearInterval(intervalId);
  let score=0;
  picked.forEach((item,idx)=>{
    const radios=form.querySelectorAll(`input[name="q${idx}"]`);
    let chosen=-1;
    radios.forEach(r=>{if(r.checked)chosen=parseInt(r.value);});
    const correct=item.a;
    radios.forEach((r,oi)=>{
      const label=r.parentElement;
      label.style.padding="6px 10px";
      label.style.borderRadius="10px";
      if(oi===correct){
        label.style.background="rgba(34,197,94,.15)";
        label.style.border="1px solid rgba(34,197,94,.35)";
        label.style.fontWeight="600";
      }
      if(oi===chosen && chosen!==correct){
        label.style.background="rgba(239,68,68,.12)";
        label.style.border="1px solid rgba(239,68,68,.35)";
      }
    });
    if(chosen===correct)score++;
  });

  // collect short answers
  const shortAnswers = REFLECTION_QUESTIONS.map((_,i)=>{
    const el = document.getElementById(`sa${i+1}`);
    return el ? el.value.trim() : "";
  });

  scoreNow.textContent=String(score);
  submitBtn.disabled=true;
  const msg=auto?"Time is up!":"Submitted.";
  result.style.display="block";
  result.innerHTML=`<strong>${msg}</strong> You scored <strong>${score}</strong> out of <strong>${TOTAL}</strong>.`;

  const timeUsed = Math.floor((Date.now()-quizStartTime)/1000);

  // Save result with short answers
  const raw=localStorage.getItem(STORAGE_KEY);
  const data=raw?JSON.parse(raw):[];
  data.push({
    name: currentPlayer.name,
    code: currentPlayer.code,
    score,
    time: timeUsed,
    date: new Date().toLocaleString(),
    shortAnswers // array of typed responses
  });
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  loadResults();
}

function loadResults(){
  const raw=localStorage.getItem(STORAGE_KEY);
  const data=raw?JSON.parse(raw):[];
  // sort by score desc, then time asc
  data.sort((a,b)=>{
    if(b.score!==a.score) return b.score-a.score;
    return a.time-b.time;
  });
  resultsBody.innerHTML="";
  data.forEach((rec,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${escapeHtml(rec.name)}</td>
      <td>${escapeHtml(rec.code)}</td>
      <td>${rec.score}</td>
      <td>${rec.time}</td>
      <td>${rec.date}</td>
      <td><button class="btn secondary view-details" data-index="${i}">View</button></td>
    `;
    resultsBody.appendChild(tr);
  });

  // wire up view buttons
  const viewBtns = document.querySelectorAll('.view-details');
  viewBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = parseInt(btn.getAttribute('data-index'));
      const rec = data[idx];
      const sa = (rec && rec.shortAnswers) ? rec.shortAnswers : [];
      let html = `<strong>${escapeHtml(rec.name)} (${escapeHtml(rec.code)})</strong><br><em>Score:</em> ${rec.score} &nbsp; <em>Time:</em> ${rec.time}s<br><hr>`;
      sa.forEach((ans, i) => {
        html += `<strong>Q${i+1}.</strong> ${escapeHtml(REFLECTION_QUESTIONS[i])}<br>${escapeHtml(ans || "(no answer)")}<br><br>`;
      });
      // simple modal using window.open-like small popup
      const w = window.open("", "_blank", "width=700,height=500,scrollbars=yes");
      w.document.title = "Participant details";
      w.document.body.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, Helvetica, sans-serif";
      w.document.body.style.padding = "18px";
      w.document.body.innerHTML = html;
    });
  });
}

function exportCSV(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw){alert("No records");return;}
  const data=JSON.parse(raw);
  // headers include short answer columns
  const headers = ["Pos","Name","Code","Score","Time Used","Date"].concat(REFLECTION_QUESTIONS.map((q,i)=>`SA${i+1}`));
  const rows=[headers];
  data.sort((a,b)=> {
    if(b.score !== a.score) return b.score-a.score;
    return a.time - b.time;
  }).forEach((rec,i)=>{
    const base = [i+1, rec.name, rec.code, rec.score, rec.time, rec.date];
    const sas = (rec.shortAnswers || []).map(s => (""+s).replace(/"/g,'""')); // escape quotes
    rows.push(base.concat(sas));
  });
  const csv = rows.map(r => r.map(cell => `"${(cell===undefined||cell===null)?"":cell}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="quiz_results.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// Escape simple HTML for display
function escapeHtml(text){
  if(text === undefined || text === null) return "";
  return String(text)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'", "&#39;");
}

// === Events ===
submitBtn.addEventListener("click",e=>{e.preventDefault(); grade(false);});
retryBtn.addEventListener("click",()=>{ renderQuiz(); startTimer(); });
document.getElementById("exportResultsBtn").addEventListener("click",exportCSV);

// === Login Overlay ===
document.getElementById("startBtn").addEventListener("click",()=>{
  const name=document.getElementById("playerName").value.trim();
  const code=document.getElementById("playerCode").value.trim();
  if(!name||!code){alert("Enter name and code");return;}
  if(!VALID_CODES.includes(code)){alert("Invalid code");return;}
  currentPlayer={name,code};
  document.getElementById("loginOverlay").style.display="none";
  document.getElementById("quizMain").style.display="block";
  renderQuiz();
  startTimer();
  loadResults();
});

// === Init ===
loadResults();
</script>
</body>
</html>
